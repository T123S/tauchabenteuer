<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0">
    
    <link rel="manifest" href="manifest.json">
    
    <title>Deep Dive: Gyro Hunter</title>
    <style>
        body { margin: 0; overflow: hidden; background-color: #001e36; font-family: 'Courier New', Courier, monospace; user-select: none; -webkit-user-select: none; }
        
        /* UI Layer (HUD) */
        #ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 5; }
        
        #score-board { 
            position: absolute; top: 20px; left: 20px; 
            color: #fff; font-size: 20px; font-weight: bold; 
            text-shadow: 2px 2px 0 #000; 
        }

        /* Sauerstoff Balken */
        #oxygen-wrapper {
            position: absolute; left: 20px; bottom: 20px;
            width: 30px; height: 30vh;
            border: 2px solid white; background: rgba(0,0,0,0.5);
            border-radius: 5px;
        }
        #oxygen-bar { 
            width: 100%; height: 100%; 
            background: linear-gradient(to top, #ff3333, #ffff33, #33ffff); 
            transform-origin: bottom; transition: height 0.2s linear; 
        }
        #oxygen-label {
            position: absolute; left: 60px; bottom: 20px;
            color: #33ffff; font-weight: bold; font-size: 24px;
            text-shadow: 2px 2px 0 #000;
        }

        /* Start / Game Over Screen */
        #menu-screen { 
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0, 20, 40, 0.95); 
            display: flex; flex-direction: column; 
            align-items: center; justify-content: center; 
            color: white; pointer-events: auto; z-index: 10;
            text-align: center;
        }
        
        h1 { margin-bottom: 10px; font-size: 3rem; color: #00d2ff; text-shadow: 0 0 10px #00d2ff; }
        p { font-size: 1.2rem; line-height: 1.5; color: #ccc; max-width: 80%; }
        
        button { 
            margin-top: 30px; padding: 20px 40px; 
            font-size: 1.5rem; font-weight: bold; 
            background: #ff9900; color: #000; border: none; border-radius: 50px; 
            cursor: pointer; box-shadow: 0 0 20px rgba(255, 153, 0, 0.6);
            transition: transform 0.1s;
        }
        button:active { transform: scale(0.95); }

        /* Warnung für Landscape Modus */
        #orientation-warning {
            display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: #000; z-index: 20; color: white;
            align-items: center; justify-content: center; text-align: center;
        }
    </style>
</head>
<body>

    <div id="ui-layer">
        <div id="score-board">Fische: 0 | Score: 0</div>
        <div id="oxygen-wrapper"><div id="oxygen-bar"></div></div>
        <div id="oxygen-label">O₂</div>
    </div>

    <div id="menu-screen">
        <h1 id="menu-title">DEEP DIVE</h1>
        <p id="menu-msg">
            Halte das Handy quer.<br>
            Neige es zum Lenken.<br>
            Tippe für TURBO.<br>
            <span style="color:#ff3333">Komm zurück zum Boot bevor die Luft ausgeht!</span>
        </p>
        <button id="start-btn">TAUCHEN</button>
        <p style="font-size: 0.8rem; margin-top:20px; color:#666" id="loading-status">Lade Konfiguration...</p>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>

    <script>
        // --- FALLBACK DATEN (Falls data.json nicht lädt) ---
        const FALLBACK_CONFIG = {
            gameConfig: { maxOxygen: 100, depletionRate: 5.0, turboCost: 15.0, fishCount: 20 },
            fishTypes: [
                { color: 0xff7f50, score: 10, scale: 0.5 },
                { color: 0xffd700, score: 50, scale: 0.8 }
            ]
        };

        // --- GLOBALE VARIABLEN ---
        let CONFIG = null; // Wird aus JSON geladen
        let scene, camera, renderer, clock;
        let player, boat;
        let fishes = []; // Array für Fisch-Objekte
        let isPlaying = false;
        
        // Game State
        let oxygen = 100;
        let score = 0;
        let fishCount = 0;
        
        // Steuerung
        let deviceInput = { beta: 0, gamma: 0 }; // Neigung
        let isTurbo = false;

        // --- 1. LADEN DER DATEN ---
        window.addEventListener('load', async () => {
            const status = document.getElementById('loading-status');
            try {
                const response = await fetch('data.json');
                if (!response.ok) throw new Error("JSON nicht gefunden");
                const data = await response.json();
                
                // Konvertiere Hex-Strings zu Zahlen falls nötig (Three.js mag 0xff0000 oder Integers)
                // Hier gehen wir davon aus, dass im JSON normale Zahlen oder Strings stehen.
                CONFIG = data;
                status.innerText = "Daten geladen. Bereit.";
                console.log("Config geladen:", CONFIG);
            } catch (error) {
                console.warn("Fehler beim Laden der data.json (CORS oder fehlt). Nutze Fallback.", error);
                CONFIG = FALLBACK_CONFIG;
                status.innerText = "Offline-Modus aktiv.";
            }

            // Button aktivieren
            document.getElementById('start-btn').addEventListener('click', requestGyroPermission);
            
            // 3D Setup vorbereiten
            initThreeJS();
        });

        // --- 2. THREE.JS SETUP ---
        function initThreeJS() {
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x001e36);
            scene.fog = new THREE.FogExp2(0x001e36, 0.015); // Unterwasser Nebel

            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 200);

            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2)); // Performance Optimierung
            document.body.appendChild(renderer.domElement);

            // Lichter
            const dirLight = new THREE.DirectionalLight(0xffffff, 1);
            dirLight.position.set(0, 50, 0);
            scene.add(dirLight);
            scene.add(new THREE.AmbientLight(0x404060));

            // Welt erstellen
            createWorld();
            
            // Event Listeners
            window.addEventListener('resize', onResize);
            // Turbo Events
            document.addEventListener('touchstart', () => isTurbo = true);
            document.addEventListener('touchend', () => isTurbo = false);
            document.addEventListener('mousedown', () => isTurbo = true); // PC Test
            document.addEventListener('mouseup', () => isTurbo = false); // PC Test

            // Desktop Maus Fallback (für Tests am PC)
            document.addEventListener('mousemove', (e) => {
                if(isPlaying) {
                    // Mappe Mausposition auf Neigung (-45 bis 45 Grad)
                    const x = (e.clientX / window.innerWidth) * 2 - 1;
                    const y = (e.clientY / window.innerHeight) * 2 - 1;
                    deviceInput.gamma = x * 45;
                    deviceInput.beta = y * 45;
                }
            });

            clock = new THREE.Clock();
            animate();
        }

        function createWorld() {
            // Boot
            const boatGeo = new THREE.BoxGeometry(6, 2, 10);
            const boatMat = new THREE.MeshPhongMaterial({ color: 0x8b5a2b });
            boat = new THREE.Mesh(boatGeo, boatMat);
            boat.position.set(0, 1, 0);
            scene.add(boat);

            // Ankerkette (Visuelle Hilfe)
            const chainGeo = new THREE.CylinderGeometry(0.1, 0.1, 80);
            const chainMat = new THREE.MeshBasicMaterial({ color: 0x555555 });
            const chain = new THREE.Mesh(chainGeo, chainMat);
            chain.position.set(0, -40, 0);
            scene.add(chain);

            // Wasseroberfläche
            const waterGeo = new THREE.PlaneGeometry(500, 500);
            const waterMat = new THREE.MeshBasicMaterial({ color: 0x00aaff, transparent: true, opacity: 0.3, side: THREE.DoubleSide });
            const water = new THREE.Mesh(waterGeo, waterMat);
            water.rotation.x = -Math.PI / 2;
            scene.add(water);

            // Spieler (Taucher)
            const playerGeo = new THREE.ConeGeometry(0.5, 2, 8);
            playerGeo.rotateX(Math.PI / 2); // Hinlegen
            const playerMat = new THREE.MeshPhongMaterial({ color: 0x00ff00, emissive: 0x002200 });
            player = new THREE.Mesh(playerGeo, playerMat);
            scene.add(player);
        }

        function spawnFishes() {
            // Alte Fische löschen
            fishes.forEach(f => scene.remove(f.mesh));
            fishes = [];

            const types = CONFIG.fishTypes;
            const count = CONFIG.gameConfig.fishCount || 20;

            for(let i=0; i<count; i++) {
                const type = types[Math.floor(Math.random() * types.length)];
                
                // Farbe parsen (falls String im JSON)
                let colorVal = type.color;
                
                const geo = new THREE.BoxGeometry(type.scale, type.scale/2, type.scale*1.5);
                const mat = new THREE.MeshPhongMaterial({ color: colorVal });
                const mesh = new THREE.Mesh(geo, mat);

                // Positionierung
                mesh.position.set(
                    (Math.random() - 0.5) * 100, // X
                    -Math.random() * 50 - 2,     // Y (Tiefe 2 bis 52)
                    (Math.random() - 0.5) * 100  // Z
                );
                
                // Zufällige Richtung
                mesh.rotation.y = Math.random() * Math.PI * 2;

                scene.add(mesh);
                
                fishes.push({
                    mesh: mesh,
                    score: type.score,
                    speed: (Math.random() * 2 + 1),
                    active: true
                });
            }
        }

        // --- 3. GYRO PERMISSION (iOS) ---
        function requestGyroPermission() {
            if (typeof DeviceOrientationEvent !== 'undefined' && typeof DeviceOrientationEvent.requestPermission === 'function') {
                DeviceOrientationEvent.requestPermission()
                    .then(response => {
                        if (response === 'granted') {
                            window.addEventListener('deviceorientation', handleOrientation);
                            startGame();
                        } else {
                            alert("Ohne Gyro keine Steuerung! :(");
                        }
                    })
                    .catch(console.error);
            } else {
                // Android & PC
                window.addEventListener('deviceorientation', handleOrientation);
                startGame();
            }
        }

        function handleOrientation(e) {
            // Werte für Landscape Modus anpassen
            // Achtung: Je nach Handy-Haltung können Beta/Gamma tauschen. 
            // Hier einfache Implementation.
            deviceInput.beta = e.beta || 0;
            deviceInput.gamma = e.gamma || 0;
        }

        // --- 4. SPIEL LOGIK ---
        function startGame() {
            document.getElementById('menu-screen').style.display = 'none';
            oxygen = CONFIG.gameConfig.maxOxygen;
            score = 0;
            fishCount = 0;
            isTurbo = false;
            
            // Spieler Reset
            player.position.set(0, -2, 10);
            player.rotation.set(0, 0, 0);

            spawnFishes();
            
            isPlaying = true;
            clock.start();
        }

        function stopGame(win) {
            isPlaying = false;
            const menu = document.getElementById('menu-screen');
            const title = document.getElementById('menu-title');
            const msg = document.getElementById('menu-msg');
            const btn = document.getElementById('start-btn');

            menu.style.display = 'flex';
            
            if (win) {
                title.innerText = "ERFOLG!";
                title.style.color = "#00ff00";
                msg.innerHTML = `Du bist sicher aufgetaucht.<br>Gefangen: ${fishCount}<br>Punkte: ${score}`;
            } else {
                title.innerText = "ERTRUNKEN!";
                title.style.color = "#ff0000";
                msg.innerHTML = `Die Luft ist ausgegangen.<br>Alle Fische verloren.`;
            }
            btn.innerText = "NOCHMAL";
        }

        function update(dt) {
            if (!isPlaying) return;

            // --- Steuerung ---
            // Beta (Kippen vorn/hinten) -> Rotation X (Hoch/Runter)
            // Gamma (Kippen links/rechts) -> Rotation Y (Links/Rechts)
            
            // Dämpfung (Lerp) für weichere Bewegung
            const targetRotX = (deviceInput.beta / 90) * 1.5; 
            const targetRotY = -(deviceInput.gamma / 90) * 1.5;

            player.rotation.x += (targetRotX - player.rotation.x) * 5 * dt;
            player.rotation.y += (targetRotY - player.rotation.y) * 5 * dt;

            // Vorwärtsbewegung
            const speed = isTurbo ? 15 : 7;
            player.translateZ(-speed * dt);

            // Grenzen
            if(player.position.y > 0.5) player.position.y = 0.5;
            if(player.position.y < -90) player.position.y = -90;

            // --- Sauerstoff ---
            let drain = CONFIG.gameConfig.depletionRate;
            if(isTurbo) drain += CONFIG.gameConfig.turboCost;
            // Tiefer = mehr Verbrauch
            drain += Math.abs(player.position.y * 0.05);

            oxygen -= drain * dt;
            if(oxygen <= 0) stopGame(false);

            // --- Kamera ---
            // Kamera folgt sanft hinterher
            const camOffset = new THREE.Vector3(0, 3, 8);
            camOffset.applyMatrix4(player.matrixWorld);
            camera.position.lerp(camOffset, 0.1);
            camera.lookAt(player.position);

            // --- Fische & Kollision ---
            fishes.forEach(f => {
                if(!f.active) return;

                // Fische schwimmen einfach geradeaus
                f.mesh.translateZ(f.speed * dt);
                
                // Kollision
                if(player.position.distanceTo(f.mesh.position) < 2.5) {
                    f.active = false;
                    f.mesh.visible = false;
                    score += f.score;
                    fishCount++;
                    // Kleiner UI Effekt könnte hier hin
                }
            });

            // --- Win Condition (Rückkehr zum Boot) ---
            if(player.position.y > -1 && player.position.distanceTo(new THREE.Vector3(0,0,0)) < 8) {
                if(fishCount > 0) stopGame(true);
            }

            // --- UI Update ---
            document.getElementById('oxygen-bar').style.height = Math.max(0, oxygen) + "%";
            document.getElementById('score-board').innerText = `Fische: ${fishCount} | Score: ${score}`;
        }

        function animate() {
            requestAnimationFrame(animate);
            const dt = clock.getDelta();
            update(dt);
            renderer.render(scene, camera);
        }

        function onResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }
    </script>
</body>
</html>